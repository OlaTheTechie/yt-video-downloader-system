# Docker Compose configuration for YouTube Video Downloader

version: '3.8'

services:
  # Development environment
  dev:
    build:
      context: .
      target: development
    volumes:
      - .:/app
      - downloads:/downloads
      - ~/.gitconfig:/home/downloader/.gitconfig:ro
    environment:
      - PYTHONPATH=/app
      - DEVELOPMENT=1
    working_dir: /app
    command: bash
    stdin_open: true
    tty: true

  # Testing environment
  test:
    build:
      context: .
      target: testing
    volumes:
      - .:/app
    environment:
      - PYTHONPATH=/app
      - CI=1
    command: pytest tests/ -v --cov=. --cov-report=term-missing

  # Production environment
  app:
    build:
      context: .
      target: production
    volumes:
      - downloads:/downloads
    environment:
      - DOWNLOADS_DIR=/downloads
    command: ["--help"]

  # Code quality checks
  quality:
    build:
      context: .
      target: development
    volumes:
      - .:/app
    environment:
      - PYTHONPATH=/app
    command: >
      bash -c "
        echo 'Running code quality checks...' &&
        black --check . &&
        isort --check-only . &&
        flake8 . --count --statistics &&
        mypy . --ignore-missing-imports &&
        bandit -r . --severity-level medium &&
        echo 'All quality checks passed!'
      "

volumes:
  downloads:
    driver: local